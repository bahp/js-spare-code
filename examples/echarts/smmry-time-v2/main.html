<html>
<head>
  <!-- CSS only -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
        crossorigin="anonymous">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/echarts/5.3.3/echarts.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/echarts-gl/2.0.8/echarts-gl.js'></script>
  <script src='data.js'></script>
  <link rel="stylesheet" href="./main.css">
</head>
<body>


  <div class="container">

    <!-- ------------------- -->
    <!-- Description         -->
    <!-- ------------------- -->
    <div class="row">
      <div class="col-12">
        <!-- Info text -->
        <div class="alert alert-warning small mt-5 pt-1 pb-1" role="alert">
          <p class="text-justify mt-2">
            The following example is incomplete. Include three buttons: (i) one
            with a text input with a default color to colour all the markers with
            the same color, (ii) another in which it uses the colors included
            manually in the configuration, (iii) another in which the values are
            colored taking into account the value, where the center value of the
            normal reference range is 'gray' and then 'red' if it goes up and
            'blue' if it goes down, (iv) the same as before but the colours only
            start when they are outside the normal reference range.

            In addition, include the units (e.g. mg/dL) when hovering and show
            additional information (e.g. report, note, ...) when available on
            the fourth dimension. Finally, maybe it would be possible to improve
            the x-axis labels which look too crowded at the moment.

            Finally, when no configuration of groups and elements included, compute
            the dictionary with group and the list of associated codes based on the
            CONFIG variable automatically (sort alphabetically too).
          </p>
        </div>
      </div>
    </div>

    <!-- ---------------------------- -->
    <!-- Chart                        -->
    <!-- ---------------------------- -->
    <div class="row">
      <div id='chart-container'></div>
    </div>

  </div>

</body>
<script>

    // -----------------------------------------------
    // Helper methods
    // -----------------------------------------------
    function getDatesInRange(startDate, endDate) {
        /**
         * Create all dates between two dates.
         *
         * .. note: It repeats the 26th of March twice!
         *
         * @type {Date}
         */
        const date = new Date(startDate.getTime());
        const dates = [];
        while (date <= endDate) {
            dates.push(new Date(date));
            date.setDate(date.getDate() + 1);
        }
        return dates;
    }

    function getDatesBetween(startDate, endDate) {
        /**
         * Create all dates between two dates.
         *
         * .. note: It repeats the 26th of March twice!
         *
         * @type {Date}
         */
        let dates = [];
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            dates.push(new Date(currentDate));
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return dates;
    };

    function getDaysBetweenDates(startDate, endDate) {
        /**
         * Create all dates between two dates.
         *
         * .. note: Requires moment.js
         */
        startDate = moment(startDate)
        endDate = moment(endDate)
        var now = startDate.clone(), dates = [];

        while (now.isSameOrBefore(endDate)) {
            dates.push(now.format('YYYY-MM-DD'));
            now.add(1, 'days');
        }
        return dates;
    };

    function generateEmptySeries(vx, vy, key) {
        /**
         *
         * @type {*[]}
         */
        // Create data
        var empty = []
        for (let i = 0; i <= vx.length; i++) {
            for (let j = 0; j <= vy.length; j++) {
                empty.push([vx[i], vy[j], -1])
            }
        }

        // Return
        return {
            name: 'empty-' + key,
            type: 'heatmap',
            data: empty,
            itemStyle: {
                color: '#F0F0F0',
                borderWidth: 3,
                borderColor: 'white',
                borderRadius: 4,
            },
            xAxisIndex: cont,
            yAxisIndex: cont,
        }
    }



    // ------------------------------
    // Generate data
    // ------------------------------
    // Generate the data
    //var data = generateData()
    //var data = getVirtualData(2023)
    var data = getVirtualDataManual()

    // See data
    console.log(data)

    // Create all days within range.
    var dates = data.map(x => x[0]);
    var minimumDate = Math.min.apply(null, dates);
    var maximumDate = Math.max.apply(null, dates);
    dates = getDaysBetweenDates(minimumDate, maximumDate)


    // Could this transform be done just once in the xAxis or series.
    //data = data.map(x => [x[0].toISOString().split('T')[0], x[1], x[2]]);
    //dates = dates.map(x => x.toISOString().split('T')[0]);
    data = data.map(x => [x[0].toISOString().split('T')[0], x[1], x[2]]);
    //dates = dates.map(x => x[0].format().split('T')[0]);



    var groups = {
        'Encounters': [ 'CAR' ],
        'Diagnoses': [ 'DIAG' ],
        'Medications': [
            'AAMI', 'AMER', 'ACPX'
        ],
        'Procedures': [ 'PROC' ],
        'Vital Signs': [
            'BTMP', 'BP', 'HR', 'O2SAT'
        ],
        'Labs': [
            'ALT', 'ALP', 'BIL', 'CRE', 'CRP',
            'GLU', 'HAE',  'PLT', 'WBC'
        ],
        'Notes': [ 'NOTE' ],
    }

    // Some constants

    // .. note: Careful, colors are overwritten on visualMap.

    // This variable indicates whether to use an specific color
    // (e.g. #FFDFD3) or if set to undefined the colors within
    // the CONFIG variable will be used.
    var UNICOLOR = undefined // '#FFDFD3' or '#B0E9D5'

    // This variable indicates whether to include empty cells
    // in a gray color in areas where there is no data available
    // which is similar to GITHUB commit approach.
    var GITHUB_STYLE = true

    // Create options
    const grids = []
    const xAxes = []
    const yAxes = []
    const series = []
    const visualMap = []

    // Loop filling elements
    var cont = -1
    var offset = 0
    for (const [key, value] of Object.entries(groups)) {
        cont = cont + 1

        // Push grid component
        grids.push({
            top: 50 + offset + 'px',
            height: 13 * value.length,
            width: 13 * dates.length,
        })

        // Update offset for next grid component
        offset = offset + (13 * value.length) + 40

        if (GITHUB_STYLE)
          series.push(generateEmptySeries(dates, value, key))

        for (i in value) {

            // Compute color
            var c = UNICOLOR
            if (c == undefined)
                c = CONFIG[value[i]].color || undefined

            // Add series
            series.push({
                name: value[i],
                type: 'heatmap',
                data: data.filter(x => x[1] == value[i]),
                itemStyle: {
                    borderWidth: 3,
                    borderRadius: 4,
                    borderColor: 'white', // hack for cellPadding
                    color: c
                },
                xAxisIndex: cont,
                yAxisIndex: cont,
            })
        }

        xAxes.push({
            data: dates,
            show: false,
            type: 'category',
            showGrid: true,
            axisLine: {
                onZero: false,
                show: false
            },
            axisTick: {
                show: true,
                alignWithLabel: true
            },
            axisLabel: {
                interval: 0,
                rotate: 90
            },
            gridIndex: cont
        })

        yAxes.push({
            type: 'category',
            scale: false,
            name: key,
            data: value,
            //nameLocation: 'top',
            nameGap: 5,
            nameTextStyle: { // https://echarts.apache.org/en/option.html#xAxis.nameTextStyle.align
                color: 'darkgray',
                fontSize: 15,
                fontStyle: 'normal',
                fontWeight: 'bolder',
                fontFamily: 'normal', // monospace
                align: 'left',
            },
            axisLine: {
                lineStyle: {
                  color: '#666'
                },
                show: false
            },
            axisTick: {
                show: false,
                alignWithLabel: true
            },
            axisLabel: {
                interval: 0,
                fontSize: 9,
                formatter: function (value, index, tick) {
                  return CONFIG[value].name || value
              }
            },
            gridIndex: cont
        })
    }

    // Show last axis.
    xAxes[Object.keys(groups).length-1].show = true

    console.log(series)

    // Create chart
    var chartDom = document.getElementById('chart-container');
    var myChart = echarts.init(chartDom);
    var option;

    // Create the complete option.
    option = {
        animation: true,
        tooltip: {
            position: 'top',
            trigger: 'item',
        },
        //title: {
        //  text: 'Summary',
        //  subtext: 'NHS111111',
        //  left: 'center'
        //},
        xAxis: xAxes,
        yAxis: yAxes,
        grid: grids,
        visualMap: [
            /**
            {
                show: false,
                type: 'continuous',
                seriesIndex: 1,
                dimension: 2,
                min: 0,
                max: 5,
            },
             {
                show: false,
                type: 'continuous',
                seriesIndex: 11,
                dimension: 2,
                min: 36,
                max: 44,
            }**/
        ],

        /*
        visualMap: {
          min: 0,
          max: 10,
          calculable: true,
          orient: 'horizontal',
          left: 'center',
          bottom: '15%'
        },*/
        series: series
    };

    // Display
    option && myChart.setOption(option);

</script>
</html>